package main

import (
	"fmt"
	"log"
	"sort"
	"strings"

	"github.com/google/renameio"
)

var header = `
# ![HAProxy](../assets/images/haproxy-weblogo-210x49.png "HAProxy")

## HAProxy kubernetes ingress controller

Options for starting controller can be found in [controller.md](controller.md)

This is autogenerated from [doc.yaml](doc.yaml). Description can be found in [generator readme](gen/README.md)

### Available annotations

> :information_source: Ingress and service annotations can have ` + "`ingress.kubernetes.io`, `haproxy.org` and `haproxy.com`" + ` prefixes
>
> Example: ` + "haproxy.com/ssl-redirect` and `haproxy.org/ssl-redirect`" + ` are same annotation

| Annotation | Type | Default | Dependencies | Config map | Ingress | Service |
| - |:-:|:-:|:-:|:-:|:-:|:-:|
`

var tableFooter = `
> :information_source: Annotations have hierarchy: ` + "`default` <- `Configmap` <- `Ingress` <- `Service`" + `
>
> Service annotations have highest priority. If they are not defined, controller goes one level up until it finds value.
>
> This is useful if we want, for instance, to change default behaviour, but want to keep default for some service. etc.

### Options

#### Global Options

Global options are set via ConfigMap ([--configmap](controller.md)) annotations.
Depending on the option, it can be in Global or Default HAProxy section.

`

var docFooter = `
### Secrets

#### tls-secret

- define through pod arguments
  - ` + "`--default-ssl-certificate`=\\<namespace\\>/\\<secret\\>" + `
- Annotation ` + "`ssl-certificate` in config map" + `
  - \<namespace\>/\<secret\>
  - this replaces default certificate
- certificate can be defined in Ingress object: ` + "`spec.tls[].secretName`" + `
- single certificate secret can contain two items:
  - tls.key
  - tls.crt
- certificate secret with ` + "`rsa` and `ecdsa` certificates:" + `
  - :information_source: only one certificate is also acceptable setup
  - rsa.key
  - rsa.crt
  - ecdsa.key
  - ecdsa.crt

### Data types

#### Port

- value between <0, 65535]

#### Sample expression

- Sample expressions/fetches are used to retrieve data from request/response buffer.
- Example:
  - headers: ` + "`hdr(header-name)`" + `
  - cookies: ` + "`cookie(cookie-name)`" + `
  - Name of the cipher used to offload SSL: ` + "`ssl_fc_cipher`" + `
- Sample expressions are covered in depth in [HAProxy documentation](https://cbonte.github.io/haproxy-dconv/2.0/configuration.html#7.3), however many are out of the ingress controller's scope.

#### Time

- number + type
- in milliseconds, "s" suffix denotes seconds
- example: "1s"
`

func (c *Conf) generateReadme() {
	var buff strings.Builder
	buff.WriteString(header)

	groups := map[string]struct{}{}
	for _, ann := range c.Items {
		if !ann.VersionMax.LowerOrEqual(c.ActiveVersion) {
			continue
		}
		devVersion := !ann.VersionMin.LowerOrEqual(c.ActiveVersion)
		// log.Println(ann.Title, ann.VersionMin, ">", c.ActiveVersion, devVersion)
		if ann.Group == "" {
			ann.Group = ann.Title
		}
		annType := ann.Type
		if ann.Type == "bool" {
			annType = `[bool](#bool)`
		}
		defaultValue := ann.Default
		if annType != "number" && ann.Default != "" {
			defaultValue = `"` + ann.Default + `"`
		}
		dev := ""
		if devVersion {
			dev = " :construction:(dev)"
		}
		groupLink := strings.ReplaceAll(ann.Group, " ", "-")
		log.Println(ann.Group, groupLink)
		// 3 can be a link to type maybe like for [IPs or CIDRs](#access-control)?
		buff.WriteString(fmt.Sprintf("| [%s](#%s)%s | %s | %s | %s |%s|%s|%s|\n",
			ann.Title, groupLink, dev, annType, defaultValue, ann.Dependencies,
			Contains(ann.AppliesTo, "configmap"), Contains(ann.AppliesTo, "ingress"), Contains(ann.AppliesTo, "service")))

		// write group
		groups[ann.Group] = struct{}{}
	}

	buff.WriteString(tableFooter)

	sortedGroups := []string{}
	for group := range groups {
		sortedGroups = append(sortedGroups, group)
	}
	sort.Strings(sortedGroups)
	for _, group := range sortedGroups {
		buff.WriteString(fmt.Sprintf("#### %s\n\n", strings.ReplaceAll(strings.Title(group), "-", " ")))
		groupData, haveGroupData := c.Groups[group]
		if haveGroupData && groupData.Header != "" {
			buff.WriteString(fmt.Sprintf("%s\n\n", groupData.Header))
		}
		for _, ann := range c.Items {
			if ann.Group != group {
				continue
			}
			buff.WriteString(fmt.Sprintf("##### `%s`\n\n", ann.Title))
			if !ann.VersionMin.LowerOrEqual(c.ActiveVersion) {
				buff.WriteString("\n  > :construction: this is only available from next version, currently available in dev build\n\n")
			}
			for _, desc := range ann.Description {
				buff.WriteString(fmt.Sprintf("  %s\n", desc))
			}
			buff.WriteString("\n  Available on:")
			for _, app := range ann.AppliesTo {
				buff.WriteString(fmt.Sprintf("  `%s`", app))
			}
			buff.WriteString("\n")
			for _, tip := range ann.Tip {
				buff.WriteString(fmt.Sprintf("\n  :information_source: %s\n", tip))
			}
			buff.WriteString("\nPossible values:\n\n")
			for _, value := range ann.Values {
				buff.WriteString(fmt.Sprintf("- %s\n", writeValue(value, ann.Default)))
			}
			buff.WriteString("\n")
			selectExamples(ann, &buff)
		}
		if haveGroupData && groupData.Footer != "" {
			buff.WriteString(fmt.Sprintf("%s\n\n", groupData.Footer))
		}
		buff.WriteString("<p align='right'><a href='#available-annotations'>:arrow_up_small: back to top</a></p>\n\n***\n\n")
	}

	buff.WriteString(docFooter)

	err := renameio.WriteFile("../README.md", []byte(buff.String()), 0644)
	if err != nil {
		log.Println(err)
	}

}

func selectExamples(ann *ConfItem, buff *strings.Builder) {
	numOverrides := 0
	numApplies := len(ann.AppliesTo)
	if ann.Title == "syslog-server" {
		numOverrides = 0
	}
	if ann.ExampleConfigmap != "" {
		numOverrides++
	}
	if ann.ExampleIngress != "" {
		numOverrides++
	}
	if ann.ExampleService != "" {
		numOverrides++
	}
	if numOverrides == 0 || numOverrides == 1 && numApplies == 1 {
		if ContainsB(ann.AppliesTo, "configmap") {
			buff.WriteString("Example:\n\n```yaml\n")
			if ann.ExampleConfigmap == "" {
				buff.WriteString(strings.Join(ann.Example, "\n"))
			} else {
				buff.WriteString(ann.ExampleConfigmap)
			}
			buff.WriteString("\n```\n\n")
		} else {
			buff.WriteString("Example:\n\n```yaml\n")
			for _, line := range ann.Example {
				if line[0] != '#' && ann.Title != "ingress.class" {
					buff.WriteString("haproxy.org/")
				}
				buff.WriteString(line)
				buff.WriteString("\n")
			}
			buff.WriteString("\n```\n\n")

		}
		return
	}

	if numOverrides == numApplies {
		if ann.ExampleConfigmap != "" {
			buff.WriteString("Example (configmap):\n\n```yaml\n")
			buff.WriteString(ann.ExampleConfigmap)
			buff.WriteString("\n```\n\n")
		}
		if ann.ExampleIngress != "" && ann.ExampleIngress == ann.ExampleService {
			buff.WriteString("Example (ingress, service):\n\n```yaml\n")
			buff.WriteString(ann.ExampleIngress)
			buff.WriteString("\n```\n\n")
		} else {
			if ann.ExampleIngress != "" {
				buff.WriteString("Example (ingress):\n\n```yaml\n")
				buff.WriteString(ann.ExampleIngress)
				buff.WriteString("\n```\n\n")
			}
			if ann.ExampleService != "" {
				buff.WriteString("Example (service):\n\n```yaml\n")
				buff.WriteString(ann.ExampleService)
				buff.WriteString("\n```\n\n")
			}
		}
	}
}

func writeValue(value, defaultValue string) string {
	if value != defaultValue {
		return value
	}
	return fmt.Sprintf("%s `default`", value)
}
